name: Release

on:
  push:
    branches:
      - master
      - beta
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (only used for manual trigger)'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Force release commit (manual trigger only)
        if: github.event_name == 'workflow_dispatch' && inputs.release_type != 'auto'
        env:
          GITHUB_TOKEN: ${{ secrets.SCRUTINY_GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          case "${{ inputs.release_type }}" in
            patch)
              COMMIT_MSG="fix: manual release trigger"
              ;;
            minor)
              COMMIT_MSG="feat: manual release trigger"
              ;;
            major)
              COMMIT_MSG="feat!: manual release trigger (BREAKING CHANGE)"
              ;;
          esac

          git commit --allow-empty -m "$COMMIT_MSG"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 24
          extra_plugins: |
            @semantic-release/commit-analyzer
            @semantic-release/release-notes-generator
            @semantic-release/changelog
            @semantic-release/exec
            @semantic-release/git
            @semantic-release/github
            conventional-changelog-conventionalcommits
        env:
          GITHUB_TOKEN: ${{ secrets.SCRUTINY_GITHUB_TOKEN }}

      - name: Get previous tag
        id: prev_tag
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 v${{ steps.semantic.outputs.new_release_version }}^ 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate release notes from PRs
        id: release_notes
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.SCRUTINY_GITHUB_TOKEN }}
        run: |
          chmod +x .github/scripts/generate-release-notes.sh
          NOTES=$(.github/scripts/generate-release-notes.sh "${{ steps.prev_tag.outputs.tag }}" "v${{ steps.semantic.outputs.new_release_version }}")
          # Write to file to preserve newlines
          echo "$NOTES" > /tmp/release-notes.md

      - name: Update release notes
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.SCRUTINY_GITHUB_TOKEN }}
        run: |
          if [ -f /tmp/release-notes.md ] && [ -s /tmp/release-notes.md ]; then
            gh release edit "v${{ steps.semantic.outputs.new_release_version }}" \
              --repo ${{ github.repository }} \
              --notes-file /tmp/release-notes.md
            echo "Release notes updated successfully"
          else
            echo "No release notes generated, keeping default"
          fi

  build:
    name: Build Binaries
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ${{ matrix.cfg.on }}
    env:
      STATIC: true
    strategy:
      fail-fast: false
      matrix:
        cfg:
          - { on: ubuntu-latest,  goos: linux,   goarch: amd64 }
          - { on: ubuntu-latest,  goos: linux,   goarch: arm,   goarm: 5 }
          - { on: ubuntu-latest,  goos: linux,   goarch: arm,   goarm: 6 }
          - { on: ubuntu-latest,  goos: linux,   goarch: arm,   goarm: 7 }
          - { on: ubuntu-latest,  goos: linux,   goarch: arm64 }
          - { on: macos-latest,   goos: darwin,  goarch: amd64 }
          - { on: macos-latest,   goos: darwin,  goarch: arm64 }
          - { on: macos-latest,   goos: freebsd, goarch: amd64 }
          - { on: windows-latest, goos: windows, goarch: amd64 }
          - { on: windows-latest, goos: windows, goarch: arm64 }
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.new_release_version }}
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Build Binaries
        env:
          GOOS: ${{ matrix.cfg.goos }}
          GOARCH: ${{ matrix.cfg.goarch }}
          GOARM: ${{ matrix.cfg.goarm }}
        run: make binary-clean binary-all
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.cfg.goos }}-${{ matrix.cfg.goarch }}${{ matrix.cfg.goarm }}
          path: |
            scrutiny-web-*
            scrutiny-collector-metrics-*
            scrutiny-collector-zfs-*
            scrutiny-collector-performance-*

  upload-assets:
    name: Upload Release Assets
    needs: [release, build]
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binaries-*
          merge-multiple: true

      - name: List files
        run: ls -la

      - name: Generate checksums
        run: |
          sha256sum scrutiny-* > SHA256SUMS.txt
          echo "Generated checksums:"
          cat SHA256SUMS.txt

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.SCRUTINY_GITHUB_TOKEN }}
        run: |
          VERSION="v${{ needs.release.outputs.new_release_version }}"
          for file in scrutiny-*; do
            if [ -f "$file" ]; then
              echo "Uploading $file..."
              gh release upload "$VERSION" "$file" --repo ${{ github.repository }} --clobber
            fi
          done
          echo "Uploading SHA256SUMS.txt..."
          gh release upload "$VERSION" SHA256SUMS.txt --repo ${{ github.repository }} --clobber
