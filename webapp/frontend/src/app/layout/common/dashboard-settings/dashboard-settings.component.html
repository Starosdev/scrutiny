<h2 mat-dialog-title>Scrutiny Settings</h2>
<mat-dialog-content class="mat-typography">

    <div class="flex flex-col p-8 pb-0 overflow-hidden">
        <div class="flex flex-col mt-5 gt-md:flex-row">

            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Dark Mode</mat-label>
                <mat-select [(ngModel)]="theme">
                    <mat-option value="system">System</mat-option>
                    <mat-option value="dark">Dark</mat-option>
                    <mat-option value="light">Light</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Display Title</mat-label>
                <mat-select [(ngModel)]="dashboardDisplay">
                    <mat-option value="name">Name</mat-option>
                    <mat-option value="serial_id">Serial ID</mat-option>
                    <mat-option value="uuid">UUID</mat-option>
                    <mat-option value="label">Label</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pl-3">
                <mat-label>Sort By</mat-label>
                <mat-select [(ngModel)]="dashboardSort">
                    <mat-option value="status_desc">Status (Failed First)</mat-option>
                    <mat-option value="status_asc">Status (Passed First)</mat-option>
                    <mat-option value="title_asc">Title (A-Z)</mat-option>
                    <mat-option value="title_desc">Title (Z-A)</mat-option>
                    <mat-option value="age_desc">Age (Oldest First)</mat-option>
                    <mat-option value="age_asc">Age (Newest First)</mat-option>
                    <mat-option value="capacity_desc">Capacity (Largest First)</mat-option>
                    <mat-option value="capacity_asc">Capacity (Smallest First)</mat-option>
                    <mat-option value="temperature_desc">Temperature (Hottest First)</mat-option>
                    <mat-option value="temperature_asc">Temperature (Coolest First)</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Temperature</mat-label>
                <mat-select [(ngModel)]="temperatureUnit">
                    <mat-option value="celsius">Celsius</mat-option>
                    <mat-option value="fahrenheit">Fahrenheit</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>File Size</mat-label>
                <mat-select [(ngModel)]="fileSizeSIUnits">
                    <mat-option [value]=true>SI Units (GB)</mat-option>
                    <mat-option [value]=false>Binary Units (GiB)</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Powered On Format</mat-label>
                <mat-select [(ngModel)]="poweredOnHoursUnit">
                    <mat-option value="humanize">Humanize</mat-option>
                    <mat-option value="device_hours">Device Hours</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Line stroke</mat-label>
                <mat-select [(ngModel)]="lineStroke">
                    <mat-option value="smooth">Smooth</mat-option>
                    <mat-option value="straight">Straight</mat-option>
                    <mat-option value="stepline">Stepline</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Device Status - Thresholds</mat-label>
                <mat-select [(ngModel)]=statusThreshold>
                    <mat-option [value]=1>Smart</mat-option>
                    <mat-option [value]=2>Scrutiny</mat-option>
                    <mat-option [value]=3>Both</mat-option>
                </mat-select>
                <mat-hint>Smart = manufacturer failures, Scrutiny = threshold failures, Both = either</mat-hint>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Notify - Filter Attributes</mat-label>
                <mat-select [(ngModel)]=statusFilterAttributes>
                    <mat-option [value]=0>All</mat-option>
                    <mat-option [value]=1>Critical</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Repeat Notifications</mat-label>
                <mat-select [(ngModel)]=repeatNotifications>
                    <mat-option [value]=true>Always</mat-option>
                    <mat-option [value]=false>Only when the value has changed</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Retrieve SCT Temperature History</mat-label>
                <mat-select [(ngModel)]=retrieveSCTTemperatureHistory>
                    <mat-option [value]=true>Enabled</mat-option>
                    <mat-option [value]=false>Disabled</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <!-- Missed Collector Ping Notifications -->
        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Notify on Missed Collector Ping</mat-label>
                <mat-select [(ngModel)]="notifyOnMissedPing">
                    <mat-option [value]="true">Enabled</mat-option>
                    <mat-option [value]="false">Disabled</mat-option>
                </mat-select>
                <mat-hint>Alert when a collector stops sending data</mat-hint>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row" *ngIf="notifyOnMissedPing">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Missed Ping Timeout (minutes)</mat-label>
                <input matInput type="number" [(ngModel)]="missedPingTimeoutMinutes" min="1">
                <mat-hint>Minutes before alerting (default: 60)</mat-hint>
            </mat-form-field>

            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pl-3">
                <mat-label>Check Interval (minutes)</mat-label>
                <input matInput type="number" [(ngModel)]="missedPingCheckIntervalMins" min="1">
                <mat-hint>How often to check (default: 5)</mat-hint>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Heartbeat Notifications</mat-label>
                <mat-select [(ngModel)]="heartbeatEnabled">
                    <mat-option [value]="true">Enabled</mat-option>
                    <mat-option [value]="false">Disabled</mat-option>
                </mat-select>
                <mat-hint>Periodic "all drives healthy" notification</mat-hint>
            </mat-form-field>
        </div>

        <div class="flex flex-col mt-5 gt-md:flex-row" *ngIf="heartbeatEnabled">
            <mat-form-field class="flex-auto gt-xs:pr-3 gt-md:pr-3">
                <mat-label>Heartbeat Interval (hours)</mat-label>
                <input matInput type="number" [(ngModel)]="heartbeatIntervalHours" min="1">
                <mat-hint>Hours between heartbeat notifications (default: 24)</mat-hint>
            </mat-form-field>
        </div>

        <!-- SMART Attribute Overrides Section -->
        <mat-expansion-panel class="mt-5">
            <mat-expansion-panel-header>
                <mat-panel-title>SMART Attribute Overrides</mat-panel-title>
                <mat-panel-description>
                    Configure ignored attributes and custom thresholds
                </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="flex flex-col p-4">
                <!-- Existing overrides table -->
                <table mat-table [dataSource]="overrides" class="w-full" *ngIf="overrides.length > 0">
                    <ng-container matColumnDef="protocol">
                        <th mat-header-cell *matHeaderCellDef>Protocol</th>
                        <td mat-cell *matCellDef="let override">{{override.protocol}}</td>
                    </ng-container>

                    <ng-container matColumnDef="attribute_id">
                        <th mat-header-cell *matHeaderCellDef>Attribute ID</th>
                        <td mat-cell *matCellDef="let override">{{override.attribute_id}}</td>
                    </ng-container>

                    <ng-container matColumnDef="action">
                        <th mat-header-cell *matHeaderCellDef>Action</th>
                        <td mat-cell *matCellDef="let override">{{getActionLabel(override.action)}}</td>
                    </ng-container>

                    <ng-container matColumnDef="source">
                        <th mat-header-cell *matHeaderCellDef>Source</th>
                        <td mat-cell *matCellDef="let override">
                            <span class="px-2 py-1 text-xs rounded"
                                  [class.bg-blue-100]="override.source === 'ui'"
                                  [class.bg-gray-100]="override.source === 'config'">
                                {{override.source}}
                            </span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let override">
                            <button mat-icon-button
                                    (click)="removeOverride(override)"
                                    [disabled]="override.source === 'config'"
                                    matTooltip="Config file overrides cannot be deleted from UI">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <p *ngIf="overrides.length === 0" class="text-gray-500 italic my-4">
                    No attribute overrides configured
                </p>

                <!-- Add new override form -->
                <div class="mt-4 p-4 border rounded">
                    <h4 class="mb-4 font-medium">Add New Override</h4>

                    <div class="flex flex-wrap gap-4">
                        <mat-form-field class="flex-1 min-w-[120px]">
                            <mat-label>Protocol</mat-label>
                            <mat-select [(ngModel)]="newOverride.protocol">
                                <mat-option *ngFor="let p of protocols" [value]="p">{{p}}</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field class="flex-1 min-w-[150px]">
                            <mat-label>Attribute ID</mat-label>
                            <input matInput [(ngModel)]="newOverride.attribute_id"
                                   placeholder="e.g., 5, media_errors">
                        </mat-form-field>

                        <mat-form-field class="flex-1 min-w-[120px]">
                            <mat-label>Action</mat-label>
                            <mat-select [(ngModel)]="newOverride.action">
                                <mat-option *ngFor="let a of actions" [value]="a.value">{{a.label}}</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field class="flex-1 min-w-[120px]"
                                        *ngIf="newOverride.action === 'force_status'">
                            <mat-label>Status</mat-label>
                            <mat-select [(ngModel)]="newOverride.status">
                                <mat-option *ngFor="let s of statuses" [value]="s">{{s}}</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field class="flex-1 min-w-[100px]"
                                        *ngIf="newOverride.action === ''">
                            <mat-label>Warn Above</mat-label>
                            <input matInput type="number" [(ngModel)]="newOverride.warn_above">
                        </mat-form-field>

                        <mat-form-field class="flex-1 min-w-[100px]"
                                        *ngIf="newOverride.action === ''">
                            <mat-label>Fail Above</mat-label>
                            <input matInput type="number" [(ngModel)]="newOverride.fail_above">
                        </mat-form-field>

                        <mat-form-field class="flex-1 min-w-[200px]">
                            <mat-label>Device WWN (optional)</mat-label>
                            <input matInput [(ngModel)]="newOverride.wwn"
                                   placeholder="Leave empty for all devices">
                        </mat-form-field>
                    </div>

                    <button mat-raised-button color="primary"
                            class="mt-4"
                            (click)="addOverride()"
                            [disabled]="!newOverride.protocol || !newOverride.attribute_id">
                        Add Override
                    </button>
                </div>
            </div>
        </mat-expansion-panel>
    </div>

</mat-dialog-content>
<mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-button mat-dialog-close (click)="saveSettings()" cdkFocusInitial>Save</button>
</mat-dialog-actions>
